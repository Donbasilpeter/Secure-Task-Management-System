<!-- Fixed Header -->
<app-header
  title="Department"
  class="fixed top-0 left-0 right-0 z-50 shadow-card"
></app-header>

<!-- Page wrapper with padding to account for fixed header -->
<div class="min-h-screen bg-secondary font-body p-8 pt-24 overflow-x-hidden overflow-y-auto">
  <div class="max-w-5xl mx-auto bg-secondary-light rounded-card shadow-card p-10 border border-tertiary/10">
    <ng-container *ngIf="department; else notFound">
      
      <!-- ðŸ”¹ Department Header -->
      <header class="mb-10 border-b pb-6 flex justify-between items-center">
        <div>
          <h1 class="text-4xl font-heading font-bold text-primary mb-2">
            {{ department.name }}
          </h1>
          <div class="text-gray-600 space-x-4 text-sm">
            <span><span class="font-medium">Role:</span> {{ department.role }}</span>
            <span class="text-gray-400">|</span>
            <span><span class="font-medium">Department ID:</span> {{ department.id }}</span>
          </div>
        </div>

        <!-- ðŸ”¹ Action buttons -->
        <ng-container *ngIf="department.role === 'admin' || department.role === 'owner'">
          <div class="flex gap-3">
            <button
              (click)="showUserModal = true"
              class="px-4 py-2 bg-primary text-secondary-light rounded-button shadow hover:bg-primary-dark transition"
            >
              Manage Users
            </button>
            <button
              (click)="showTaskModal = true"
              class="px-4 py-2 bg-accent-gold text-tertiary font-semibold rounded-button shadow hover:opacity-90 transition"
            >
              Create Task
            </button>
          </div>
        </ng-container>
      </header>

      <!-- ðŸ”¹ Task List -->
      <section>
        <h2 class="text-2xl font-heading font-semibold text-primary mb-4">Tasks</h2>

        <ng-container *ngIf="taskStore.tasks().length > 0; else noTasks">
          <ul class="space-y-4">
            <li *ngFor="let task of taskStore.tasks()"
                (click)="onOpenTask(task)"
                class="p-5 border rounded-card shadow-card bg-secondary hover:bg-secondary-dark transition cursor-pointer">
              <div class="flex justify-between items-center mb-2">
                <h3 class="font-heading font-semibold text-lg text-tertiary">{{ task.title }}</h3>
                <span class="text-xs text-gray-500">{{ task.createdAt | date:'medium' }}</span>
              </div>
              <p class="text-gray-700 mb-2">{{ task.description }}</p>
              <p class="text-sm text-gray-500">
                <span class="font-medium">Created by:</span> {{ task.createdBy?.name || 'Unknown' }} |
                <span class="font-medium">Assigned to:</span> {{ task.assignedTo?.name || 'Unassigned' }}
              </p>
            </li>
          </ul>
        </ng-container>

        <ng-template #noTasks>
          <div class="p-6 text-center text-gray-500 bg-secondary-dark rounded-card border">
            No tasks found in this department.
          </div>
        </ng-template>
      </section>
    </ng-container>

    <ng-template #notFound>
      <div class="p-6 text-center text-gray-500 bg-secondary-dark rounded-card border">
        Department not found.
      </div>
    </ng-template>
  </div>
</div>

<!-- ðŸ”¹ Manage Users Modal -->
<div *ngIf="showUserModal" class="fixed inset-0 bg-tertiary/70 flex items-center justify-center z-50 overflow-hidden">
  <div class="bg-secondary-light rounded-card shadow-card w-full max-w-lg max-h-screen overflow-auto p-6 relative">
    <button (click)="showUserModal = false" 
            class="absolute top-3 right-3 text-gray-400 hover:text-tertiary">âœ•</button>
    <h2 class="text-xl font-heading font-semibold text-primary mb-4">Manage Users</h2>

    <!-- ðŸ”¹ Users List -->
    <div *ngIf="departmentStore.users().length > 0; else noUsers" class="mb-6">
      <ul class="divide-y divide-gray-200 border rounded-card bg-secondary-dark max-h-64 overflow-y-auto">
        <li *ngFor="let u of departmentStore.users()" class="flex justify-between items-center px-4 py-3">
          <div>
            <p class="font-medium text-tertiary">{{ u.name || u.email }}</p>
            <p class="text-xs text-gray-500">{{ u.role }}</p>
          </div>
        </li>
      </ul>
    </div>

    <ng-template #noUsers>
      <div class="p-4 text-center text-gray-500 bg-secondary rounded-card border">
        No users found in this department.
      </div>
    </ng-template>

    <!-- ðŸ”¹ Add User Form -->
    <form [formGroup]="addUserForm" (ngSubmit)="onAddUser()" class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-tertiary mb-1">User Email</label>
        <input type="email" formControlName="email"
               class="w-full border border-gray-300 rounded-button px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary"
               placeholder="Enter user email" />
      </div>
      <div>
        <label class="block text-sm font-medium text-tertiary mb-1">Role</label>
        <select formControlName="role"
                class="w-full border border-gray-300 rounded-button px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary">
          <option value="viewer">Viewer</option>
          <option value="admin">Admin</option>
        </select>
      </div>
      <div class="flex justify-end">
        <button type="submit"
                class="px-6 py-2 bg-primary text-secondary-light rounded-button shadow hover:bg-primary-dark transition"
                [disabled]="addUserForm.invalid">
          Add User
        </button>
      </div>
    </form>
  </div>
</div>

<!-- ðŸ”¹ Create Task Modal -->
<div *ngIf="showTaskModal" class="fixed inset-0 bg-tertiary/70 flex items-center justify-center z-50 overflow-hidden">
  <div class="bg-secondary-light rounded-card shadow-card w-full max-w-lg max-h-screen overflow-auto p-6 relative">
    <button (click)="showTaskModal = false" 
            class="absolute top-3 right-3 text-gray-400 hover:text-tertiary">âœ•</button>
    <h2 class="text-xl font-heading font-semibold text-primary mb-4">Create Task</h2>
    <form [formGroup]="taskForm" (ngSubmit)="onCreateTask()" class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-tertiary mb-1">Title</label>
        <input type="text" formControlName="title"
               class="w-full border border-gray-300 rounded-button px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary"
               placeholder="Enter task title" />
      </div>
      <div>
        <label class="block text-sm font-medium text-tertiary mb-1">Description</label>
        <textarea formControlName="description" rows="3"
                  class="w-full border border-gray-300 rounded-button px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary"
                  placeholder="Enter task description"></textarea>
      </div>

      <!-- ðŸ”¹ Assignee Dropdown -->
      <div>
        <label class="block text-sm font-medium text-tertiary mb-1">Assign To</label>
        <select formControlName="assignedToId"
                class="w-full border border-gray-300 rounded-button px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary">
          <option [value]="authStore.user()?.id">Myself</option>
          <ng-container *ngFor="let u of departmentStore.users()">
            <option *ngIf="u.id !== authStore.user()?.id" [value]="u.id">
              {{ u.name || u.email }}
            </option>
          </ng-container>
        </select>
      </div>

      <div class="flex justify-end">
        <button type="submit"
                class="px-6 py-2 bg-accent-gold text-tertiary font-semibold rounded-button shadow hover:opacity-90 transition"
                [disabled]="taskForm.invalid">
          Create Task
        </button>
      </div>
    </form>
  </div>
</div>

<!-- ðŸ”¹ Task Comments Modal -->
<div *ngIf="showCommentsModal" class="fixed inset-0 bg-tertiary/70 flex items-center justify-center z-50 overflow-hidden">
  <div class="bg-secondary-light rounded-card shadow-card w-full max-w-2xl max-h-screen overflow-auto p-6 relative">
    <button (click)="showCommentsModal = false"
            class="absolute top-3 right-3 text-gray-400 hover:text-tertiary">âœ•</button>

    <h2 class="text-xl font-heading font-semibold text-primary mb-4">
      Comments for {{ selectedTask?.title }}
    </h2>

    <!-- ðŸ”¹ Comments List -->
    <div *ngIf="comments.length > 0; else noComments" class="space-y-4 mb-6">
      <div *ngFor="let c of comments" class="p-4 bg-secondary-dark rounded-card border">
        <p class="text-sm text-gray-700">{{ c.comment }}</p>
        <p class="text-xs text-gray-500 mt-1">
          By {{ c.user?.name || c.user?.email }} Â· {{ c.createdAt | date:'short' }}
        </p>
      </div>
    </div>
    <ng-template #noComments>
      <p class="text-gray-500 text-center">No comments yet.</p>
    </ng-template>

    <!-- ðŸ”¹ Add Comment Form (if permission) -->
    <form *ngIf="department?.role === 'admin' || department?.role === 'owner' || selectedTask?.assignedTo?.id === authStore.user()?.id"
          [formGroup]="commentForm"
          (ngSubmit)="onAddComment()"
          class="space-y-4 border-t pt-4 mt-4">
      <label class="block text-sm font-medium text-tertiary">Add Comment</label>
      <textarea formControlName="comment" rows="3"
                class="w-full border border-gray-300 rounded-button px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary"
                placeholder="Write your comment..."></textarea>
      <div class="flex justify-end">
        <button type="submit"
                class="px-6 py-2 bg-primary text-secondary-light rounded-button shadow hover:bg-primary-dark transition"
                [disabled]="commentForm.invalid">
          Post Comment
        </button>
      </div>
    </form>
  </div>
</div>
